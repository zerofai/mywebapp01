# Docker
# Build and Push a Docker image 
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build image
  jobs:  
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      displayName: Build and Push image
      inputs:
        command: buildAndPush
        containerRegistry: 'tenableio-consec'
        repository: 'azure/azure-webapp01'
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        tags: |
          $(tag)
    - task: InvokeRESTAPI@1
      inputs:
        connectionType: 'connectedServiceName'
        method: 'GET'
        headers: |
          {
          "Content-Type":"application/json", 
          "x-apikeys": "accessKey=d8ade8faa6ce250a8e0f1e0780c3afd5e9ef7e0913a64a7f55db3c78ffd4017b;secretKey=35b89e7722942ae6c5b9b738c8d67958750c09313c4754f0bcae22ae62d263a4", 
          }
        urlSuffix: 'https://cloud.tenable.com/container-security/api/v1/compliancebyname?image=azure-webapp01&repo=azure&tag=$(tag)'
        waitForCompletion: 'false'
        successCriteria: 'eq(root[''status''], ''pass'''